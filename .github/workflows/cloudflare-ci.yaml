on:
  pull_request:
    branches:
    - main
jobs:
  build-and-preview:
    name: Build and test cloudflare deployment
    runs-on: ubuntu-latest
    env:
      SANITY_STUDIO_PROJECT_ID: ${{ secrets.SANITY_STUDIO_PROJECT_ID }}
      SANITY_STUDIO_DATASET: ${{ secrets.SANITY_STUDIO_DATASET }}
      SANITY_STUDIO_URL: ${{ secrets.SANITY_STUDIO_URL }}
      SANITY_STUDIO_PREVIEW_ORIGIN: ${{ secrets.SANITY_STUDIO_PREVIEW_ORIGIN }}
      SANITY_STUDIO_VIEWER_TOKEN: ${{ secrets.SANITY_STUDIO_VIEWER_TOKEN }}
      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      SMTP_SECURE: ${{ secrets.SMTP_SECURE }}
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASS }}
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js version of Cloudflare
      uses: actions/setup-node@v5
      with:
        node-version: '22.16.0'
    - name: Install deps and build
      run: |
        npm install
        npm run build:cloudflare
    - name: Check bundle size
      run: |
        # Run wrangler deploy --dry-run and capture output
        OUTPUT=$(npx wrangler deploy --dry-run 2>&1)
        echo "$OUTPUT"
        
        # Extract gzipped size in KiB
        GZIP_SIZE=$(echo "$OUTPUT" | grep "Total Upload:" | grep -oP 'gzip: \K[0-9.]+')
        
        if [ -z "$GZIP_SIZE" ]; then
          echo "‚ùå Error: Could not extract gzip size from wrangler output"
          exit 1
        fi
        
        echo "üì¶ Gzipped bundle size: ${GZIP_SIZE} KiB"
        
        # Convert to MB for better readability
        GZIP_SIZE_MB=$(awk "BEGIN {printf \"%.2f\", $GZIP_SIZE / 1024}")
        echo "üì¶ Gzipped bundle size: ${GZIP_SIZE_MB} MB"
        
        # Check if size exceeds 3MB (3072 KiB)
        LIMIT_KIB=3072
        EXCEEDS=$(awk "BEGIN {print ($GZIP_SIZE > $LIMIT_KIB) ? 1 : 0}")
        
        if [ "$EXCEEDS" -eq 1 ]; then
          echo "‚ùå Bundle size ${GZIP_SIZE} KiB (${GZIP_SIZE_MB} MB) exceeds the 3MB limit (${LIMIT_KIB} KiB)"
          exit 1
        else
          REMAINING=$(awk "BEGIN {printf \"%.2f\", ($LIMIT_KIB - $GZIP_SIZE) / 1024}")
          echo "‚úÖ Bundle size is within limits. ${REMAINING} MB remaining."
        fi
